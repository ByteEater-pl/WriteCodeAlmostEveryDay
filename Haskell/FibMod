main = print $ fibMod 0 8

fibMod m i =
  (\[_,x,_]->x) $ pow [0,1,1] i
  where
    -- really (`mod` 0) should be id per mathematical definition
    modulo = if m>0 then (`mod` m) else id
    pow f@[a,b,c] i = let (q,r) = divMod i 2
      in if q>0
      then
        (`pow` q) $
        take 3 $
        drop r $
        map modulo [
          a*a+b*b,
          (a+c)*b,
          b*b+c*c,
          (2*b+c)*c]
      else [[0,1,1],f]!!r
